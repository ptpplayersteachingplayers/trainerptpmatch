<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PTP Trainer Matcher</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: #f1f1f1;
    }
    #map {
      height: 60vh;
      width: 100%;
    }
    .controls {
      padding: 20px 10px;
      background: #000;
      text-align: center;
    }
    .controls input, .controls select, .controls button {
      padding: 10px;
      margin: 5px;
      border-radius: 5px;
      border: none;
      font-size: 1em;
      width: 90%;
      max-width: 300px;
      background: #1e1e1e;
      color: #f1f1f1;
    }
    .controls button {
      background: #FFD700;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    .trainer-list {
      padding: 20px;
    }
    .trainer-card {
      background: #1a1a1a;
      margin: 10px auto;
      padding: 15px;
      border-left: 5px solid #FFD700;
      border-radius: 8px;
      max-width: 500px;
      color: #f1f1f1;
    }
    .trainer-card h3 {
      color: #FFD700;
      margin-top: 0;
    }
    .btn {
      background: #FFD700;
      color: #000;
      padding: 10px 20px;
      text-decoration: none;
      font-weight: bold;
      display: inline-block;
      margin-top: 10px;
      border-radius: 5px;
    }
    .sticky-cta {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #FFD700;
      text-align: center;
      padding: 15px;
      font-weight: bold;
      font-size: 1.1em;
      color: #000;
      z-index: 999;
    }
  </style>
</head>
<body>
  <div class="controls">
    <h1 style="color: #FFD700;">üîç Find the Best Soccer Trainer Near You</h1>
    <button onclick="useMyLocation()">üìç Use My Location</button>
    <input id="zipFallback" placeholder="or enter ZIP code" />
    <button onclick="useZipLocation()">üîç Search ZIP</button>
    <select id="positionFilter">
      <option value="">All Positions</option>
      <option value="Defender">Defender</option>
      <option value="Midfielder">Midfielder</option>
      <option value="Striker">Striker</option>
      <option value="Goalkeeper">Goalkeeper</option>
    </select>
  </div>

  <div id="map"></div>
  <div class="trainer-list" id="trainerList"></div>
  <div class="sticky-cta">‚öΩ Spots Filling Fast ‚Äì Book Your Private Training Today!</div>

  <script>
    let map, trainers = [], originCoords = null;
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSClTYNvQo15rYGb6Au-Uxk84CxTuJ1Q5sLEhXd2ReLm0JyUbhQhOMSi1-I50hf3Rs4TArW6gmgbqfa/pub?gid=2095822811&single=true&output=csv";

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 40.0, lng: -75.2 },
        zoom: 9
      });

      fetch(csvUrl)
        .then(res => res.text())
        .then(text => {
          const rows = text.split('\\n').slice(1);
          for (let row of rows) {
            const [name, zip, link, fieldName, fieldZip, address, lat, lng, rating, reviews, img, position] = row.split(',');
            if (!lat || !lng || isNaN(parseFloat(lat)) || isNaN(parseFloat(lng))) continue;
            const latLng = { lat: parseFloat(lat), lng: parseFloat(lng) };
            trainers.push({ name, zip, link, fieldName, fieldZip, address, lat: latLng.lat, lng: latLng.lng, rating, reviews, img, position });
            new google.maps.Marker({ position: latLng, map, title: name });
          }
        }).catch(err => {
          document.getElementById("trainerList").innerHTML = "‚ùå Failed to load trainer data.";
          console.error(err);
        });
    }

    function useMyLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          originCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          matchTrainerToClosestField();
        }, () => alert("Location access denied."));
      } else {
        alert("Geolocation not supported.");
      }
    }

    function useZipLocation() {
      const zip = document.getElementById("zipFallback").value.trim();
      fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${zip}&key=AIzaSyASLf8mjb8iEbVo99DnaaPzXGlu5jhXrZE`)
        .then(res => res.json())
        .then(data => {
          if (!data.results || !data.results[0] || !data.results[0].geometry) {
            alert("Invalid ZIP code");
            return;
          }
          const loc = data.results[0].geometry.location;
          originCoords = { lat: loc.lat, lng: loc.lng };
          matchTrainerToClosestField();
        }).catch(() => alert("ZIP lookup failed."));
    }

    function matchTrainerToClosestField() {
      const positionPref = document.getElementById("positionFilter").value.toLowerCase();
      const list = document.getElementById("trainerList");
      const sorted = trainers
        .filter(t => !positionPref || (t.position && t.position.toLowerCase().includes(positionPref)))
        .map(t => {
          const dist = Math.hypot(originCoords.lat - t.lat, originCoords.lng - t.lng);
          return { ...t, dist };
        })
        .sort((a, b) => a.dist - b.dist);

      list.innerHTML = '';
      sorted.slice(0, 5).forEach(t => {
        const div = document.createElement("div");
        div.className = "trainer-card";
        div.innerHTML = `
          <h3>${t.name}</h3>
          <p><strong>Position:</strong> ${t.position}</p>
          <p><strong>Address:</strong> ${t.address}</p>
          <p><strong>Distance:</strong> ${t.dist.toFixed(2)}</p>
          <a href="${t.link}" class="btn" target="_blank">Book Now</a>`;
        list.appendChild(div);
      });
    }
  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyASLf8mjb8iEbVo99DnaaPzXGlu5jhXrZE&callback=initMap"></script>
</body>
</html>
