<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PTP Trainer Matcher</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: #f1f1f1;
    }
    #map {
      height: 60vh;
      width: 100%;
    }
    .controls {
      padding: 20px 10px;
      background: #000;
      text-align: center;
    }
    .controls input, .controls select, .controls button {
      padding: 10px;
      margin: 5px;
      border-radius: 5px;
      border: none;
      font-size: 1em;
      width: 90%;
      max-width: 300px;
      background: #1e1e1e;
      color: #f1f1f1;
    }
    .controls button {
      background: #FFD700;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    .trainer-list { padding: 20px; }
    .trainer-card {
      background: #1a1a1a;
      margin: 10px auto;
      padding: 15px;
      border-left: 5px solid #FFD700;
      border-radius: 8px;
      max-width: 500px;
      color: #f1f1f1;
    }
    .trainer-card h3 { color: #FFD700; margin-top: 0; }
    .btn {
      background: #FFD700;
      color: #000;
      padding: 10px 20px;
      text-decoration: none;
      font-weight: bold;
      display: inline-block;
      margin-top: 10px;
      border-radius: 5px;
    }
    .sticky-cta {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #FFD700;
      text-align: center;
      padding: 15px;
      font-weight: bold;
      font-size: 1.1em;
      color: #000;
      z-index: 999;
    }
  </style>
</head>
<body>
  <div class="controls">
    <h1 style="color: #FFD700;">üîç Find the Best Soccer Trainer Near You</h1>
    <button onclick="useMyLocation()">üìç Use My Location</button>
    <input id="zipFallback" placeholder="or enter ZIP code" />
    <button onclick="useZipLocation()">üîç Search ZIP</button>
    <select id="positionFilter">
      <option value="">All Positions</option>
      <option value="Defender">Defender</option>
      <option value="Midfielder">Midfielder</option>
      <option value="Striker">Striker</option>
      <option value="Goalkeeper">Goalkeeper</option>
    </select>
  </div>
  <div id="map"></div>
  <div class="trainer-list" id="trainerList"></div>
  <div class="sticky-cta">‚öΩ Spots Filling Fast ‚Äì Book Your Private Training Today!</div>

  <script>
    let map, originCoords = null, popupInfo;
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSClTYNvQo15rYGb6Au-Uxk84CxTuJ1Q5sLEhXd2ReLm0JyUbhQhOMSi1-I50hf3Rs4TArW6gmgbqfa/pub?gid=2095822811&single=true&output=csv";
    const trainers = [];
    const fields = [];

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 40.05, lng: -75.4 },
        zoom: 10
      });

      fetch(csvUrl)
        .then(res => res.text())
        .then(text => {
          const rows = text.trim().split("\\n").slice(1);
          rows.forEach(row => {
            const [name, zip, link, fieldName, fieldZip, address, lat, lng, rating, reviews, img, position] = row.split(",");
            const latNum = parseFloat(lat), lngNum = parseFloat(lng);
            if (!isNaN(latNum) && !isNaN(lngNum)) {
              const latLng = { lat: latNum, lng: lngNum };
              if (!fields.find(f => f.name === fieldName)) {
                fields.push({ name: fieldName, zip: fieldZip, lat: latNum, lng: lngNum, address });
                new google.maps.Marker({
                  position: latLng,
                  map,
                  icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
                  title: fieldName
                });
              }
              trainers.push({ name, zip, link, fieldName, fieldZip, address, lat: latNum, lng: lngNum, rating, reviews, img, position });
            }
          });
        });
    }

    function useMyLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          originCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          matchTrainerToClosestField();
        }, () => alert("Location access denied."));
      }
    }
    function useZipLocation() {
      const zip = document.getElementById("zipFallback").value.trim();
      if (!zip) return alert("Please enter a ZIP code.");
      fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${zip}&key=AIzaSyASLf8mjb8iEbVo99DnaaPzXGlu5jhXrZE`)
        .then(res => res.json())
        .then(data => {
          if (!data.results?.[0]?.geometry?.location) throw new Error();
          const { lat, lng } = data.results[0].geometry.location;
          originCoords = { lat, lng };
          matchTrainerToClosestField();
        })
        .catch(() => alert("Invalid ZIP code or lookup failed."));
    }

    function matchTrainerToClosestField() {
      const filter = document.getElementById("positionFilter").value.toLowerCase();
      const results = trainers
        .filter(t => !filter || t.position?.toLowerCase().includes(filter))
        .map(t => ({ ...t, dist: Math.hypot(t.lat - originCoords.lat, t.lng - originCoords.lng) }))
        .sort((a, b) => a.dist - b.dist)
        .slice(0, 5);

      const container = document.getElementById("trainerList");
      container.innerHTML = "";
      results.forEach((t, i) => {
        const el = document.createElement("div");
        el.className = "trainer-card";
        el.innerHTML = `<h3>${t.name}</h3>
          <p><strong>Position:</strong> ${t.position}</p>
          <p><strong>Field:</strong> ${t.fieldName}</p>
          <p><strong>Address:</strong> ${t.address}</p>
          <p><strong>Distance:</strong> ${t.dist.toFixed(2)}</p>
          <p><strong>Rating:</strong> ${t.rating}</p>
          <p><em>${t.reviews}</em></p>
          <a class="btn" href="${t.link}" target="_blank">Book Now</a>`;
        container.appendChild(el);

        if (i === 0) {
          if (popupInfo) popupInfo.close();
          popupInfo = new google.maps.InfoWindow({
            content: `<strong>${t.name}</strong><br>${t.position}<br>${t.rating}‚≠ê<br><em>${t.reviews}</em><br><a href='${t.link}' target='_blank'>Book</a>`
          });
          popupInfo.setPosition({ lat: t.lat, lng: t.lng });
          popupInfo.open(map);
        }
      });
    }
  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyASLf8mjb8iEbVo99DnaaPzXGlu5jhXrZE&callback=initMap"></script>
</body>
</html>
